PELOADER地址被占用的问题

问题引人

LOADER要加载一个EXE文件，这个EXE文件加载的地址是在0x400000。在我们LOADER的MAIN函数里面，这个地址已经被占用，而你是不能去Free这个地址重新分布的，这样可能会导致程序崩溃。

问题产生

LOADER引用了一些DLL里面的API，这样导入表里会出现这些DLL，当你LOADER运行的时候，系统会帮你加载这些DLL，这些DLL会进行初始话，创建线程等操作，那地址被占用的概率是非常大的。这个也是在TLS执行之前的。

问题解决
1）延迟加载DLL，保证导入表中只有kernel32.dll
2)不要使用MFC，因为这个时候很难有机会占用要加载的地址
3）用驱动HOOK 分配内存的函数，禁止其分配某个地址开始的一片地址。

如果要使用MFC写LOADER，那唯一的办法就是
延迟加载DLL，保证导入表中只有kernel32.dll
接着挂起创建自己，分配保留内存，退出。